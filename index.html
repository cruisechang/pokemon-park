<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂØ∂ÂèØÂ§¢ÂÉèÁ¥†Ê®ÇÂúí - Áé©ÂÖ∑Ê¥æÂ∞çÁâà (Áâ©ÁêÜ‰øÆÊ≠£)</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        :root {
            --gb-bg: #c0c0c0;
            --screen-bg: #74c365;
            --ui-text: #333;
        }

        * { box-sizing: border-box; user-select: none; }
        
        body {
            margin: 0; padding: 0; min-height: 100vh;
            display: flex; justify-content: center; align-items: center;
            background-color: #2c2c2c;
            font-family: 'Press Start 2P', 'DotGothic16', 'Microsoft JhengHei', sans-serif;
            overflow-y: auto;
        }

        .device-container {
            width: 800px; max-width: 95vw; 
            height: auto; min-height: 600px; 
            background-color: #f2f2f2;
            border-radius: 20px 20px 40px 40px; padding: 30px;
            box-shadow: inset -5px -5px 10px rgba(0,0,0,0.1), 10px 10px 20px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; border: 4px solid #333;
            position: relative; margin: 20px 0;
        }

        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding: 0 10px; color: #333; font-size: 12px;
            flex-shrink: 0; font-weight: bold; letter-spacing: 1px;
        }
        .brand { color: #2e4a85; font-size: 16px; text-shadow: 2px 2px 0px #ccc; }

        .screen-container {
            position: relative; height: 400px; flex-grow: 1;
            background-color: #333; border-radius: 10px 10px 30px 10px;
            padding: 15px; box-shadow: inset 2px 2px 5px rgba(0,0,0,0.5);
        }

        #game-stage {
            width: 100%; height: 100%;
            background-color: var(--screen-bg);
            border: 2px solid #222; position: relative; overflow: hidden;
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewport="0 0 24 24" style="fill:black;stroke:white;stroke-width:1px;"><path d="M7 2l12 11.2-5.8.5 3.3 7.3-2.2.9-3.2-7.4-4.4 4V2z"/></svg>'), auto;
            image-rendering: pixelated;
            transition: background-color 1s ease;
        }

        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

        .pokemon-sprite {
            position: absolute; width: 64px; height: 64px;
            transform-origin: bottom center; cursor: grab; z-index: 10;
            filter: drop-shadow(2px 4px 0px rgba(0,0,0,0.3));
            transition: transform 0.1s;
        }
        .pokemon-sprite:active { cursor: grabbing; }

        .food-item {
            position: absolute; font-size: 24px; z-index: 5;
            animation: bounce 1s infinite; filter: drop-shadow(0px 2px 2px rgba(0,0,0,0.3));
        }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* Ë∂≥ÁêÉÊ®£Âºè */
        .toy-ball {
            position: absolute; font-size: 28px; z-index: 8;
            cursor: grab;
            transition: transform 0.1s linear;
            filter: drop-shadow(2px 4px 2px rgba(0,0,0,0.4));
        }
        .toy-ball:active { cursor: grabbing; }

        .loading-spinner {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            display: none; z-index: 100; background: rgba(255,255,255,0.9);
            padding: 20px; border: 2px solid #333; text-align: center; color: #2e4a85; font-size: 14px;
        }

        .controls {
            margin-top: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
            background: #dcdcdc; padding: 15px; border-radius: 10px; border: 2px solid #999; flex-shrink: 0;
        }
        input[type="text"] {
            flex-grow: 1; padding: 12px; 
            font-family: 'Press Start 2P', 'DotGothic16', sans-serif;
            background: #fff; border: 2px solid #555; font-size: 12px; min-width: 150px;
        }
        button {
            padding: 12px 15px; font-family: 'Press Start 2P', 'DotGothic16', sans-serif;
            background: #ffcc00; border: 2px solid #333; box-shadow: 4px 4px 0px #333;
            cursor: pointer; font-size: 12px; transition: transform 0.1s, box-shadow 0.1s; white-space: nowrap;
        }
        button:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px #333; }
        
        #feedBtn { background: #ff99cc; color: #330033; }
        #toyBtn { background: #66ccff; color: #003366; }

        .status-led {
            width: 10px; height: 10px; background-color: red; border-radius: 50%;
            box-shadow: 0 0 5px red; margin-right: 10px; animation: blink 2s infinite;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        .tooltip {
            position: absolute; background: #fff; border: 2px solid #000;
            padding: 5px 8px; font-size: 10px; border-radius: 4px; pointer-events: none;
            white-space: nowrap; z-index: 20; opacity: 0; transition: opacity 0.2s;
        }
        .shiny-star { color: gold; text-shadow: 1px 1px 0 #000; margin-left: 5px; }

        .time-indicator {
            position: absolute; top: 10px; right: 10px; 
            background: rgba(0,0,0,0.6); color: #fff; 
            padding: 5px 10px; font-size: 10px; border-radius: 10px;
            z-index: 50; display: flex; align-items: center; gap: 5px;
        }
    </style>
</head>
<body>

<div class="device-container">
    <div class="top-bar">
        <div style="display:flex; align-items:center;">
            <div class="status-led"></div>
            <span class="brand">ÂØ∂ÂèØÂ§¢ÂÉèÁ¥†Ê®ÇÂúí +</span>
        </div>
        <div>ÈõªÈáè ///</div>
    </div>

    <div class="screen-container">
        <div id="game-stage">
            <div id="timeDisplay" class="time-indicator">‚òÄÔ∏è DAY</div>
            <canvas id="bgCanvas"></canvas>
            <canvas id="fxCanvas"></canvas>
            <div id="loading" class="loading-spinner">ÈÄ£Á∑ö‰∏≠...<br>Ë´ãÁ®çÂÄô</div>
        </div>
    </div>

    <div class="controls">
        <label for="pokeName" style="font-size:12px;">ÂêçÁ®±:</label>
        <input type="text" id="pokeName" placeholder="‰æãÂ¶Ç: ÁöÆÂç°‰∏ò, ÂÇëÂ∞ºÈæú" value="ÁöÆÂç°‰∏ò">
        <button id="summonBtn">Âè¨Âñö</button>
        <button id="feedBtn">È§µÈ£ü</button>
        <button id="toyBtn">Áé©ÂÖ∑</button>
        <button id="clearBtn" style="background:#ff5555; color:white;">Ê∏ÖÈô§</button>
    </div>
    
    <div style="margin-top: 10px; font-size: 12px; color: #666; text-align: right; line-height: 1.5;">
        ÊîØÊè¥‰∏≠Ëã±Ëº∏ÂÖ• ‚Ä¢ üîä Èü≥Êïà ‚Ä¢ ‚öΩ Ë∏¢ÁêÉ‰∫íÂãï
    </div>
</div>

<script>
    // --- Configuration ---
    const API_BASE = 'https://pokeapi.co/api/v2/pokemon/';
    const STAGE = document.getElementById('game-stage');
    const BG_CANVAS = document.getElementById('bgCanvas');
    const FX_CANVAS = document.getElementById('fxCanvas');
    const INPUT = document.getElementById('pokeName');
    const LOADING = document.getElementById('loading');
    const TIME_DISPLAY = document.getElementById('timeDisplay');
    
    // --- Data Maps ---
    const nameMap = {
        "ÁöÆÂç°‰∏ò": "pikachu", "Èõ∑‰∏ò": "raichu",
        "Â¶ôËõôÁ®Æ": "bulbasaur", "Â¶ôËõôËçâ": "ivysaur", "Â¶ôËõôËä±": "venusaur",
        "Â∞èÁÅ´Èæç": "charmander", "ÁÅ´ÊÅêÈæç": "charmeleon", "Âô¥ÁÅ´Èæç": "charizard",
        "ÂÇëÂ∞ºÈæú": "squirtle", "Âç°Âí™Èæú": "wartortle", "Ê∞¥ÁÆ≠Èæú": "blastoise",
        "‰ºäÂ∏É": "eevee", "Ê∞¥‰ºäÂ∏É": "vaporeon", "Èõ∑‰ºäÂ∏É": "jolteon", "ÁÅ´‰ºäÂ∏É": "flareon",
        "Â§™ÈôΩ‰ºäÂ∏É": "espeon", "Êúà‰∫Æ‰ºäÂ∏É": "umbreon", "Ëëâ‰ºäÂ∏É": "leafeon", "ÂÜ∞‰ºäÂ∏É": "glaceon", "‰ªôÂ≠ê‰ºäÂ∏É": "sylveon",
        "Âç°ÊØîÁç∏": "snorlax", "ËÄøÈ¨º": "gengar", "ÁôæËÆäÊÄ™": "ditto", "ÂñµÂñµ": "meowth",
        "ÂèØÈÅîÈ¥®": "psyduck", "ËÉñ‰∏Å": "jigglypuff", "Âø´Èæç": "dragonite", "ÈØâÈ≠öÁéã": "magikarp",
        "Êö¥ÈØâÈæç": "gyarados", "ÊãâÊôÆÊãâÊñØ": "lapras", "Ë∂ÖÂ§¢": "mewtwo", "Â§¢Âπª": "mew",
        "ËèäËçâËëâ": "chikorita", "ÁÅ´ÁêÉÈº†": "cyndaquil", "Â∞èÈã∏È±∑": "totodile",
        "Ê≥¢ÂÖãÊØî": "togepi", "ÊûúÁÑ∂ÁøÅ": "wobbuffet", "Áè≠Âü∫ÊãâÊñØ": "tyranitar", "Ê¥õÂ•á‰∫û": "lugia", "È≥≥Áéã": "ho-oh",
        "Êú®ÂÆàÂÆÆ": "treecko", "ÁÅ´Á®öÈõû": "torchic", "Ê∞¥Ë∫çÈ≠ö": "mudkip",
        "Ê≤ôÂ•àÊúµ": "gardevoir", "ÁÉàÁ©∫Âùê": "rayquaza", "ËìãÊ≠êÂç°": "kyogre", "Âõ∫ÊãâÂ§ö": "groudon", "Âü∫ÊãâÁ•à": "jirachi",
        "ËçâËãóÈæú": "turtwig", "Â∞èÁÅ´ÁÑ∞Áå¥": "chimchar", "Ê≥¢Âä†Êõº": "piplup",
        "Ë∑ØÂç°Âà©Ê≠ê": "lucario", "ÁÉàÂí¨Èô∏ÈØä": "garchomp", "ÈòøÁàæÂÆôÊñØ": "arceus",
        "Ëó§Ëó§Ëõá": "snivy", "ÊöñÊöñË±¨": "tepig", "Ê∞¥Ê∞¥Áç∫": "oshawott", "Á¥¢ÁæÖ‰∫ûÂÖã": "zoroark"
    };

    const typeColors = {
        normal: '#a8a878', fire: '#e69d8d', water: '#8bc5cd', grass: '#74c365',
        electric: '#f8d030', ice: '#98d8d8', fighting: '#c03028', poison: '#a040a0',
        ground: '#e0c068', flying: '#a890f0', psychic: '#f85888', bug: '#a8b820',
        rock: '#b8a038', ghost: '#705898', dragon: '#7038f8', steel: '#b8b8d0',
        fairy: '#ee99ac'
    };

    // --- State ---
    let pokemons = [];
    let foods = [];
    let balls = []; 
    let particles = [];
    let ctxBg = BG_CANVAS.getContext('2d');
    let ctxFx = FX_CANVAS.getContext('2d');
    let stageWidth, stageHeight;
    let currentBgColor = '#74c365'; 
    let isNight = false;

    // --- Initialization ---
    function resize() {
        stageWidth = STAGE.clientWidth;
        stageHeight = STAGE.clientHeight;
        BG_CANVAS.width = FX_CANVAS.width = stageWidth;
        BG_CANVAS.height = FX_CANVAS.height = stageHeight;
        drawBackground();
    }
    window.addEventListener('resize', resize);
    setTimeout(resize, 100);

    // --- Day/Night Cycle ---
    function checkDayNight() {
        const hour = new Date().getHours();
        const nowNight = (hour >= 18 || hour < 6);
        if (isNight !== nowNight) {
            isNight = nowNight;
            drawBackground();
            updateTimeDisplay();
        }
    }
    function updateTimeDisplay() {
        TIME_DISPLAY.innerHTML = isNight ? 'üåô NIGHT' : '‚òÄÔ∏è DAY';
        TIME_DISPLAY.style.background = isNight ? 'rgba(50,50,100,0.8)' : 'rgba(255,165,0,0.6)';
    }

    function drawBackground() {
        ctxBg.fillStyle = currentBgColor;
        ctxBg.fillRect(0, 0, stageWidth, stageHeight);
        ctxBg.strokeStyle = 'rgba(0,0,0,0.05)';
        ctxBg.lineWidth = 2;
        const gridSize = 40;
        for (let x = 0; x <= stageWidth; x += gridSize) {
            ctxBg.beginPath(); ctxBg.moveTo(x, 0); ctxBg.lineTo(x, stageHeight); ctxBg.stroke();
        }
        for (let y = 0; y <= stageHeight; y += gridSize) {
            ctxBg.beginPath(); ctxBg.moveTo(0, y); ctxBg.lineTo(stageWidth, y); ctxBg.stroke();
        }
        if (isNight) {
            ctxBg.fillStyle = 'rgba(0, 0, 40, 0.4)';
            ctxBg.fillRect(0, 0, stageWidth, stageHeight);
        }
    }

    // --- Class: Food ---
    class Food {
        constructor(x, y) {
            this.x = x; this.y = y; this.width = 24; this.height = 24;
            this.el = document.createElement('div');
            this.el.className = 'food-item';
            this.el.innerText = 'ü´ê'; 
            this.el.style.left = `${x}px`; this.el.style.top = `${y}px`;
            STAGE.appendChild(this.el);
        }
        remove() { this.el.remove(); }
    }

    // --- Class: ToyBall (Physic Fixes) ---
    class ToyBall {
        constructor(x, y) {
            this.x = x; this.y = y;
            this.width = 30; this.height = 30;
            this.vx = 0; this.vy = 0;
            // ‰øÆÊ≠£ 1: Êë©Êì¶ÂäõÂä†Â§ß (0.95 -> 0.92) ËÆìÁêÉÊõ¥ÂÆπÊòìÂÅú‰∏ã
            this.friction = 0.92; 
            this.el = document.createElement('div');
            this.el.className = 'toy-ball';
            this.el.innerText = '‚öΩ';
            this.el.style.left = `${x}px`; this.el.style.top = `${y}px`;
            
            this.el.addEventListener('mousedown', (e) => this.handleMouseDown(e));
            STAGE.appendChild(this.el);
        }

        update() {
            if (this.isDragging) return;

            this.x += this.vx;
            this.y += this.vy;
            
            this.vx *= this.friction;
            this.vy *= this.friction;

            if (Math.abs(this.vx) < 0.1) this.vx = 0;
            if (Math.abs(this.vy) < 0.1) this.vy = 0;

            // ‰øÆÊ≠£ 2: ÊíûÁâÜÂèçÂΩàÊ∏õÂº± (-0.8 -> -0.6)
            if (this.x <= 0) { this.x = 0; this.vx *= -0.6; }
            if (this.x >= stageWidth - this.width) { this.x = stageWidth - this.width; this.vx *= -0.6; }
            if (this.y <= 0) { this.y = 0; this.vy *= -0.6; }
            if (this.y >= stageHeight - this.height) { this.y = stageHeight - this.height; this.vy *= -0.6; }

            this.render();
        }

        render() {
            this.el.style.transform = `translate(${this.x}px, ${this.y}px) rotate(${this.x * 2}deg)`;
        }

        handleMouseDown(e) {
            e.preventDefault();
            this.isDragging = true;
            this.vx = 0; this.vy = 0;
            this.offsetX = e.clientX - this.el.getBoundingClientRect().left;
            this.offsetY = e.clientY - this.el.getBoundingClientRect().top;
            activeDragBall = this;
            this.el.style.cursor = 'grabbing';
        }

        remove() { this.el.remove(); }
    }

    // --- Class: Pokemon ---
    class Pokemon {
        constructor(displayName, spriteUrl, scale = 1, isShiny = false, cryUrl = null) {
            this.name = displayName;
            this.cryUrl = cryUrl;
            this.width = 64 * scale; this.height = 64 * scale;
            this.x = Math.random() * (stageWidth - this.width);
            this.y = Math.random() * (stageHeight - this.height);
            this.baseSpeed = 0.5 + Math.random() * 1.5;
            this.speed = this.baseSpeed;
            this.state = 'idle'; 
            this.direction = 1; this.moveTimer = 0;
            this.kickCooldown = 0;

            this.el = document.createElement('img');
            this.el.src = spriteUrl;
            this.el.className = 'pokemon-sprite';
            this.el.style.width = `${this.width}px`; this.el.style.height = `${this.height}px`;
            this.el.draggable = false;
            
            this.tooltip = document.createElement('div');
            this.tooltip.className = 'tooltip';
            this.tooltip.innerHTML = displayName + (isShiny ? '<span class="shiny-star">‚òÖ</span>' : '');
            STAGE.appendChild(this.tooltip);

            this.el.addEventListener('mousedown', (e) => this.handleMouseDown(e));
            this.el.addEventListener('click', (e) => {
                this.handleClick(e);
                this.playCry(); 
                this.wakeUp();  
            });
            this.el.addEventListener('mouseenter', () => this.tooltip.style.opacity = 1);
            this.el.addEventListener('mouseleave', () => this.tooltip.style.opacity = 0);

            STAGE.appendChild(this.el);
            if(isShiny) spawnSparkles(this.x + this.width/2, this.y + this.height/2);
            setTimeout(() => this.playCry(), 500);
        }

        playCry() {
            if (this.cryUrl) {
                const audio = new Audio(this.cryUrl);
                audio.volume = 0.2; 
                audio.play().catch(e => {});
            }
        }

        wakeUp() {
            if (this.state === 'sleeping') {
                this.state = 'idle';
                this.moveTimer = 0;
            }
        }

        update() {
            if (this.state === 'dragged') return;

            this.speed = isNight ? this.baseSpeed * 0.5 : this.baseSpeed;
            if (this.kickCooldown > 0) this.kickCooldown--;

            if (foods.length > 0 && this.state !== 'eating' && this.state !== 'sleeping') {
                this.handleFeedingLogic();
            } 
            else if (balls.length > 0 && this.state !== 'eating' && this.state !== 'sleeping') {
                this.handleBallPlaying();
            }
            else if (this.state === 'sleeping') {
                if (Math.random() < 0.05) spawnZzz(this.x + this.width/2, this.y);
                if (Math.random() < 0.005) this.wakeUp();
            } 
            else if (this.state !== 'seeking_food' && this.state !== 'chasing_ball') {
                this.handleRandomWalk();
            }

            if (this.state !== 'sleeping') {
                this.x += this.vx || 0; this.y += this.vy || 0;
            }

            if (this.x <= 0) { this.x = 0; this.vx *= -1; }
            if (this.x >= stageWidth - this.width) { this.x = stageWidth - this.width; this.vx *= -1; }
            if (this.y <= 0) { this.y = 0; this.vy *= -1; }
            if (this.y >= stageHeight - this.height) { this.y = stageHeight - this.height; this.vy *= -1; }
            
            if ((this.vx > 0)) this.direction = -1;
            if ((this.vx < 0)) this.direction = 1;
            
            this.render();
        }

        handleBallPlaying() {
            let nearestBall = null;
            let minDist = 200; 

            balls.forEach(ball => {
                const dist = Math.sqrt((ball.x - this.x)**2 + (ball.y - this.y)**2);
                if(dist < minDist) { minDist = dist; nearestBall = ball; }
            });

            if (nearestBall) {
                this.state = 'chasing_ball';
                const angle = Math.atan2(nearestBall.y - this.y, nearestBall.x - this.x);
                this.vx = Math.cos(angle) * this.speed;
                this.vy = Math.sin(angle) * this.speed;

                if (minDist < 40 && this.kickCooldown === 0) {
                    // ‰øÆÊ≠£ 3: ÂØ∂ÂèØÂ§¢Ë∏¢ÁêÉÂäõÈÅìÊ∏õÂº± (8 -> 6)
                    nearestBall.vx = Math.cos(angle) * 6; 
                    nearestBall.vy = Math.sin(angle) * 6;
                    this.kickCooldown = 60; 
                    this.playCry(); 
                }
            } else {
                if (this.state === 'chasing_ball') this.state = 'idle';
            }
        }

        handleRandomWalk() {
            this.moveTimer++;
            if (this.moveTimer > 100 + Math.random() * 200) {
                if (isNight && this.state === 'idle' && Math.random() < 0.3) {
                    this.state = 'sleeping';
                    this.vx = 0; this.vy = 0;
                } else if (this.state === 'idle') {
                    this.state = 'moving';
                    this.vx = (Math.random() - 0.5) * this.speed;
                    this.vy = (Math.random() - 0.5) * this.speed;
                } else { 
                    this.state = 'idle'; 
                    this.vx = 0; this.vy = 0; 
                }
                this.moveTimer = 0;
            }
        }

        handleFeedingLogic() {
            let nearest = null; let minDist = Infinity;
            foods.forEach(food => {
                const dist = Math.sqrt((food.x - this.x)**2 + (food.y - this.y)**2);
                if(dist < minDist) { minDist = dist; nearest = food; }
            });
            if (nearest) {
                this.state = 'seeking_food';
                const angle = Math.atan2(nearest.y - this.y, nearest.x - this.x);
                this.vx = Math.cos(angle) * (this.speed * 1.5);
                this.vy = Math.sin(angle) * (this.speed * 1.5);
                if (minDist < 10) this.eatFood(nearest);
            } else { this.state = 'idle'; }
        }

        eatFood(food) {
            const index = foods.indexOf(food);
            if (index > -1) {
                foods.splice(index, 1); food.remove();
                spawnHearts(this.x + this.width/2, this.y);
                this.state = 'idle'; this.vx = 0; this.vy = 0;
                this.el.style.transform += " scale(1.1)"; 
                setTimeout(() => { this.render(); }, 200); 
                this.playCry(); 
            }
        }

        render() {
            this.el.style.transform = `translate(${this.x}px, ${this.y}px) scaleX(${this.direction})`;
            this.tooltip.style.left = `${this.x + this.width/2}px`;
            this.tooltip.style.top = `${this.y}px`;
        }

        handleMouseDown(e) {
            e.preventDefault(); 
            this.wakeUp(); 
            this.state = 'dragged'; this.vx = 0; this.vy = 0;
            this.offsetX = e.clientX - this.el.getBoundingClientRect().left;
            this.offsetY = e.clientY - this.el.getBoundingClientRect().top;
            activeDrag = this; this.el.style.cursor = 'grabbing'; this.el.style.zIndex = 100;
        }

        handleClick(e) {
            if(Math.abs(this.vx) > 0.1 || Math.abs(this.vy) > 0.1) return;
            spawnHearts(this.x + this.width/2, this.y);
        }
    }

    // --- Drag Logic ---
    let activeDrag = null;
    let activeDragBall = null;

    document.addEventListener('mousemove', (e) => {
        const rect = STAGE.getBoundingClientRect();
        
        if (activeDrag) {
            let nx = e.clientX - rect.left - activeDrag.offsetX;
            let ny = e.clientY - rect.top - activeDrag.offsetY;
            nx = Math.max(0, Math.min(nx, stageWidth - activeDrag.width));
            ny = Math.max(0, Math.min(ny, stageHeight - activeDrag.height));
            activeDrag.x = nx; activeDrag.y = ny; activeDrag.render();
        }

        if (activeDragBall) {
            let nx = e.clientX - rect.left - activeDragBall.offsetX;
            let ny = e.clientY - rect.top - activeDragBall.offsetY;
            nx = Math.max(0, Math.min(nx, stageWidth - activeDragBall.width));
            ny = Math.max(0, Math.min(ny, stageHeight - activeDragBall.height));
            activeDragBall.x = nx; activeDragBall.y = ny; 
            
            // ‰øÆÊ≠£ 4: ÊäïÊì≤ÈùàÊïèÂ∫¶Â§ßÊ∏õ (0.5 -> 0.15) ËÆìÁêÉ‰∏çÊúÉÈ£õÂ§™Âø´
            activeDragBall.vx = (e.movementX) * 0.15;
            activeDragBall.vy = (e.movementY) * 0.15;
            
            activeDragBall.render();
        }
    });

    document.addEventListener('mouseup', () => {
        if (activeDrag) {
            activeDrag.state = 'idle'; activeDrag.el.style.cursor = 'grab';
            activeDrag.el.style.zIndex = 10; activeDrag = null;
        }
        if (activeDragBall) {
            activeDragBall.isDragging = false;
            activeDragBall.el.style.cursor = 'grab';
            activeDragBall = null;
        }
    });

    // --- Particles ---
    class Particle {
        constructor(x, y, type = 'heart') {
            this.x = x; this.y = y; this.type = type; this.life = 1.0;
            if (type === 'zzz') { this.vx = 0.5; this.vy = -0.5; } 
            else { this.vy = -1 - Math.random(); this.vx = (Math.random() - 0.5) * 2; }
        }
        update() { this.x += this.vx; this.y += this.vy; this.life -= 0.02; }
        draw(ctx) {
            ctx.save(); ctx.globalAlpha = this.life;
            if (this.type === 'heart') { ctx.font = "20px Arial"; ctx.fillText("‚ù§Ô∏è", this.x, this.y); } 
            else if (this.type === 'sparkle') { ctx.font = "15px Arial"; ctx.fillText("‚ú®", this.x, this.y); } 
            else if (this.type === 'zzz') { 
                ctx.font = "bold 14px Arial"; ctx.fillStyle = "#fff"; ctx.strokeStyle = "#000"; ctx.lineWidth = 2; 
                ctx.strokeText("Zzz", this.x, this.y); ctx.fillText("Zzz", this.x, this.y); 
            }
            ctx.restore();
        }
    }
    function spawnHearts(x, y) { for(let i=0; i<3; i++) particles.push(new Particle(x, y-20, 'heart')); }
    function spawnSparkles(x, y) { for(let i=0; i<8; i++) particles.push(new Particle(x, y, 'sparkle')); }
    function spawnZzz(x, y) { particles.push(new Particle(x, y-10, 'zzz')); }

    // --- Actions ---
    async function summonPokemon() {
        const rawInput = INPUT.value.trim();
        if (!rawInput) return;
        
        let queryName = rawInput.toLowerCase();
        let displayName = rawInput;

        if (nameMap[rawInput]) { queryName = nameMap[rawInput]; displayName = rawInput; } 
        else { displayName = queryName.charAt(0).toUpperCase() + queryName.slice(1); }

        const isShiny = Math.random() < 0.1; 
        LOADING.style.display = 'block';
        document.getElementById('summonBtn').disabled = true;

        try {
            const res = await fetch(API_BASE + queryName);
            if (!res.ok) throw new Error('Not found');
            const data = await res.json();
            
            const animObj = data.sprites.versions['generation-v']['black-white'].animated;
            let spriteUrl = isShiny ? animObj.front_shiny : animObj.front_default;
            if (!spriteUrl) spriteUrl = isShiny ? data.sprites.front_shiny : data.sprites.front_default;

            let cryUrl = data.cries ? (data.cries.latest || data.cries.legacy) : null;

            if (data.types && data.types.length > 0) {
                const typeName = data.types[0].type.name;
                if (typeColors[typeName]) {
                    currentBgColor = typeColors[typeName];
                    drawBackground(); 
                }
            }

            if(spriteUrl) {
                let scale = 1;
                if(data.weight > 1000) scale = 1.5;
                if(data.weight < 100) scale = 0.8;
                pokemons.push(new Pokemon(displayName, spriteUrl, scale, isShiny, cryUrl));
                INPUT.value = '';
            }
        } catch (e) { alert("Êâæ‰∏çÂà∞Ë©≤ÂØ∂ÂèØÂ§¢! Ë´ãÁ¢∫Ë™çÂêçÁ®±„ÄÇ"); } 
        finally { LOADING.style.display = 'none'; document.getElementById('summonBtn').disabled = false; INPUT.focus(); }
    }

    function spawnFood() {
        const x = 50 + Math.random() * (stageWidth - 100);
        const y = 50 + Math.random() * (stageHeight - 100);
        foods.push(new Food(x, y));
    }

    function spawnToy() {
        const x = stageWidth / 2;
        const y = 50;
        balls.push(new ToyBall(x, y));
    }

    function loop() {
        checkDayNight();
        ctxFx.clearRect(0, 0, stageWidth, stageHeight);
        
        pokemons.forEach(p => p.update());
        balls.forEach(b => b.update());

        for (let i = particles.length - 1; i >= 0; i--) {
            particles[i].update(); particles[i].draw(ctxFx);
            if (particles[i].life <= 0) particles.splice(i, 1);
        }
        requestAnimationFrame(loop);
    }

    document.getElementById('summonBtn').addEventListener('click', summonPokemon);
    document.getElementById('feedBtn').addEventListener('click', spawnFood); 
    document.getElementById('toyBtn').addEventListener('click', spawnToy); 
    document.getElementById('clearBtn').addEventListener('click', () => {
        pokemons.forEach(p => { p.el.remove(); p.tooltip.remove(); });
        foods.forEach(f => f.remove());
        balls.forEach(b => b.remove());
        pokemons = []; foods = []; balls = [];
        currentBgColor = '#74c365';
        drawBackground();
    });
    INPUT.addEventListener('keypress', (e) => { if (e.key === 'Enter') summonPokemon(); });

    updateTimeDisplay();
    loop();
    INPUT.value = 'ÁöÆÂç°‰∏ò'; 
    setTimeout(summonPokemon, 500);
    setTimeout(spawnToy, 1000);
</script>
</body>
</html>